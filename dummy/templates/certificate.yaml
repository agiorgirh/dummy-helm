apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: {{ "chart.fullname" . }}-store-password
  annotations:
    "helm.sh/hook": "pre-install"
    "helm.sh/hook-delete-policy": "before-hook-creation"
data:
  password: {{ randAlphaNum 20 | b64enc | quote }}

{{ if eq (include "helm-common-templates.is-tls-enabled" .) "true" }}

---

apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: {{ "chart.fullname" . }}-tls-secret
  annotations:
    "helm.sh/hook": "post-delete"
    "helm.sh/hook-delete-policy": "before-hook-creation, hook-succeeded"
data:

---

apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: {{ "chart.fullname" . }}-certificate
  labels:
    app.kubernetes.io/managed-by: {{ .Release.Service | quote }}
    app.kubernetes.io/instance: {{ .Release.Name | quote }}
    helm.sh/chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
spec:
  secretName: {{ "chart.fullname" . }}-tls-secret
  duration: {{ .Values.tls.certificate.duration }}
  renewBefore: {{ .Values.tls.certificate.renewBefore }}
  commonName: {{ .Release.Name }}.{{ .Release.Namespace }}
  dnsNames:
    # Pod DNS name
    - "localhost"
    - "*.{{ .Release.Namespace }}.pod"
    {{- if .Values.global.kubernetes.clusterDomain }}
    - "*.{{ .Release.Namespace }}.pod.{{ .Values.global.kubernetes.clusterDomain }}"
      {{- end }}
      {{- if .Values.tls.certificate.dnsNames }}
      # Additionally declared DNS names
    {{- range .Values.tls.certificate.dnsNames }}
    - "{{ . }}"
    {{- end }}
    {{- end }}
    # The service name, for when accessed through service
    - {{ template "chart.fullname" . }}.{{ .Release.Namespace }}.svc
    {{- if .Values.global.kubernetes.clusterDomain }}
    - "{{ template "chart.fullname" . }}.{{ .Release.Namespace }}.svc.{{ .Values.global.kubernetes.clusterDomain }}"
  {{- end }}
  {{- if .Values.tls.certificate.ipAddresses }}
  ipAddresses:
    # Additionally declared IP addresses
    {{- range .Values.tls.certificate.ipAddresses }}
    - "{{ . }}"
  {{- end }}
  {{- end }}
  subject:
    organizations:
      - Openet
  isCA: false
  privateKey:
    rotationPolicy: Always
  keystores:
    jks:
      create: true
      passwordSecretRef:
        name: {{ "chart.fullname" . }}-store-password
        key: password
  issuerRef:
    name: {{ .Values.tls.certificate.issuer }}
    kind: ClusterIssuer
    group: cert-manager.io
  {{end}}
